name: Test

on: [push, pull_request]

jobs:
  build_and_test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libtss2-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pkgconf openssl@3 autoconf automake libtool autoconf-archive json-c libusb

        # Use upstream HEAD, which includes the macOS addgroup/groupadd configure fix.
        git clone --depth 1 https://github.com/tpm2-software/tpm2-tss.git "$RUNNER_TEMP/tpm2-tss"
        cd "$RUNNER_TEMP/tpm2-tss"
        ./bootstrap
        ./configure \
          --prefix="$HOME/.local/tpm2-tss" \
          --disable-doxygen-doc \
          --disable-fapi \
          --disable-policy \
          --disable-tcti-cmd
        make -j"$(sysctl -n hw.ncpu)"
        make install

        {
          echo "PKG_CONFIG_PATH=$HOME/.local/tpm2-tss/lib/pkgconfig:$(brew --prefix openssl@3)/lib/pkgconfig"
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)"
          echo "DYLD_FALLBACK_LIBRARY_PATH=$HOME/.local/tpm2-tss/lib:$(brew --prefix openssl@3)/lib"
        } >> "$GITHUB_ENV"

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Run cargo clippy
      run: cargo clippy --workspace -- -D warnings

    - name: Run cargo test
      run: cargo test --workspace --all-targets -- --test-threads=1
